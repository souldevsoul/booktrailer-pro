// BookTrailer Pro - AI Book Trailer Video Generation Platform
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  emailVerified DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Credits system for trailer generation
  credits       Int       @default(0)

  // Relations
  subscriptions Subscription[]
  trailers      BookTrailer[]
  books         Book[]
  usage         UsageLog[]
  creditLedger  CreditLedger[]

  @@map("users")
}

// Book model - user's book information
model Book {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Book details
  title       String
  author      String
  genre       String   // thriller, romance, sci-fi, mystery, fantasy, etc.
  description String   @db.Text
  synopsis    String?  @db.Text // Short synopsis for trailer

  // Book metadata
  isbn        String?
  publishDate DateTime?
  coverImageUrl String?

  // Target audience
  targetAge   String?  // young-adult, adult, children, etc.
  keywords    String[] // Tags for better trailer generation

  status      String   @default("draft") // draft, published

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  trailers    BookTrailer[]

  @@index([userId])
  @@index([genre])
  @@map("books")
}

// BookTrailer model - AI-generated book trailers
model BookTrailer {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  bookId          String
  book            Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Trailer details
  title           String
  description     String?  @db.Text

  // Template and style
  templateId      String   // cinematic-thriller, romance-soft, sci-fi-epic, etc.
  style           String   // dark, light, dramatic, upbeat, mysterious
  duration        Int      // in seconds (30, 60, 90, 120)

  // Generated content
  videoUrl        String?  // Vercel Blob or Replicate URL
  thumbnailUrl    String?
  script          String?  @db.Text // AI-generated script/narration

  // AI generation settings
  aiPrompt        String   @db.Text // Prompt used for generation
  model           String   @default("runway-gen3") // runway-gen3, stable-diffusion-video, etc.

  // Music and audio
  musicTrack      String?  // Selected music track ID
  narrationVoice  String?  // Voice ID if narration included
  soundEffects    String[] // Sound effect IDs used

  // Status tracking
  status          String   @default("pending") // pending, processing, completed, failed
  errorMessage    String?
  processingTime  Float?   // in seconds

  // Cost tracking
  generationCost  Float?   // in credits or dollars

  // Publishing
  isPublic        Boolean  @default(false)
  publishedAt     DateTime?
  views           Int      @default(0)
  likes           Int      @default(0)

  // Export formats
  exports         TrailerExport[]

  createdAt       DateTime @default(now())
  completedAt     DateTime?
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([templateId])
  @@index([createdAt])
  @@map("book_trailers")
}

// TrailerExport model - different format exports
model TrailerExport {
  id              String   @id @default(cuid())
  trailerId       String
  trailer         BookTrailer @relation(fields: [trailerId], references: [id], onDelete: Cascade)

  // Export details
  format          String   // mp4-1080p, mp4-720p, mp4-4k, webm, gif
  platform        String   // youtube, instagram, tiktok, facebook, twitter
  resolution      String   // 1920x1080, 1080x1920, 1080x1080, etc.
  aspectRatio     String   // 16:9, 9:16, 1:1, 4:5

  // File details
  fileUrl         String
  fileSize        Int      // in bytes
  duration        Int      // in seconds

  status          String   @default("pending") // pending, processing, completed, failed

  createdAt       DateTime @default(now())
  completedAt     DateTime?

  @@index([trailerId])
  @@index([platform])
  @@map("trailer_exports")
}

// TrailerTemplate model - pre-built trailer templates
model TrailerTemplate {
  id              String   @id @default(cuid())

  // Template details
  name            String
  description     String   @db.Text
  genre           String[] // Suitable genres
  style           String   // cinematic, minimal, epic, romantic, etc.
  mood            String[] // dark, mysterious, upbeat, emotional, etc.

  // Preview
  previewUrl      String?  // Video preview
  thumbnailUrl    String

  // Template settings
  defaultDuration Int      @default(60) // seconds
  musicTracks     String[] // Compatible music track IDs
  transitions     String[] // Transition styles included
  effects         String[] // Visual effects included

  // Pricing
  isPremium       Boolean  @default(false)
  creditsRequired Int      @default(10)

  // Featured
  isFeatured      Boolean  @default(false)
  usageCount      Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([genre])
  @@index([style])
  @@index([isFeatured])
  @@map("trailer_templates")
}

// MusicTrack model - background music library
model MusicTrack {
  id          String   @id @default(cuid())

  title       String
  artist      String?
  genre       String[] // cinematic, epic, romantic, suspense, etc.
  mood        String[] // dark, uplifting, mysterious, intense, etc.

  duration    Int      // in seconds
  tempo       String   // slow, medium, fast

  audioUrl    String   // URL to music file
  waveformUrl String?  // URL to waveform visualization

  // Licensing
  isRoyaltyFree Boolean @default(true)
  license     String   @default("commercial-use")

  // Usage
  usageCount  Int      @default(0)
  isPremium   Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([genre])
  @@index([mood])
  @@map("music_tracks")
}

// Subscription model
model Subscription {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Subscription details
  plan              String    // free, author, publisher, studio
  status            String    @default("active") // active, cancelled, expired

  // Billing
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  stripePriceId         String?
  stripeCurrentPeriodEnd DateTime?

  // Usage limits
  monthlyTrailerLimit   Int       @default(2)
  maxDuration           Int       @default(60) // seconds
  allowHDExports        Boolean   @default(false)
  allow4KExports        Boolean   @default(false)
  allowCustomBranding   Boolean   @default(false)
  allowCommercialUse    Boolean   @default(true)
  accessPremiumTemplates Boolean  @default(false)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  cancelledAt       DateTime?

  @@index([userId])
  @@index([stripeCustomerId])
  @@map("subscriptions")
}

// UsageLog model - tracks usage for analytics
model UsageLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  action      String   // generate_trailer, export_video, view_trailer, etc.
  trailerId   String?
  cost        Float?   // in credits

  metadata    Json?    // Additional data

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("usage_logs")
}

// CreditLedger model - tracks all credit transactions
model CreditLedger {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount      Int      // Positive for additions, negative for deductions
  type        String   // TRAILER_GENERATION, CREDIT_PURCHASE, REFUND, BONUS, etc.
  description String   @db.Text

  metadata    Json?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("credit_ledger")
}

// Newsletter Subscriber model
model NewsletterSubscriber {
  id            String   @id @default(cuid())
  email         String   @unique
  status        String   @default("active")
  source        String   @default("popup")
  subscribedAt  DateTime @default(now())
  unsubscribedAt DateTime?

  @@index([email])
  @@index([status])
  @@map("newsletter_subscribers")
}
